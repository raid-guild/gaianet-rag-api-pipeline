# API Pipeline Manifest - Overview

The `rag-api-pipeline` utilizes [Airbyte's CDK low-code framework](https://docs.airbyte.com/connector-development/config-based/low-code-cdk-overview) to build source connectors for REST APIs. It generates a [declarative stream](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/yaml-overview) manifest in YAML format using two required specification files:

1. A well-defined [OpenAPI specification](https://swagger.io/specification/) for the target REST API. Most API providers publish their OpenAPI-based schema definitions. If unavailable, various [tools](https://openapi.tools/) can generate or convert API spec schemas into the required format.
2. A source RAG API pipeline manifest

## RAG API Pipeline Manifest - Schema Definition

A manifest template is available in the [repository](https://github.com/raid-guild/gaianet-rag-api-pipeline/blob/main/config/api_pipeline_template.yaml). The API pipeline manifest MUST comply with the following schema:

### api_name

An alphanumeric name for the API pipeline.

### api_parameters

Contains parameters required for building API requests. These parameters MUST be included in the [spec](/manifest-definition/overview#spec) section, and their values are accessible through the `config` object throughout the manifest.

### api_config

Defines the following API metadata for building requests:

- `request_method`: HTTP request method to use (e.g., "get")
- `content_type`: API-supported content type (e.g., "application/json")
- `response_entrypoint_field`: Field that wraps data records (e.g., "data"). Can be set to an empty string if not required

### chunking_params

Parameters used to adjust how the `unstructured` library applies chunking to normalized data. Detailed explanations are available in this [link](https://docs.unstructured.io/open-source/core-functionality/chunking). Default parameter values are:

- `mode`: "elements"
- `chunking_strategy`: "by_title"
- `include_orig_elements`: true
- `max_characters`: 1500
- `new_after_n_chars`: 1024
- `overlap`: 0
- `overlap_all`: false
- `combine_text_under_n_chars`: 0
- `multipage_sections`: true

### Airbyte Connector Definitions

An Airbyte declarative manifest requires the following schema definitions:

#### spec

A source specification comprising connector metadata and configuration options ([Docs](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/reference#/definitions/Spec)). All parameters defined in the `api_parameters` section must be listed under `required` and `properties`.

#### selector

The record selector translates an HTTP response into a list of Airbyte records by extracting records from the response ([Docs](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/record-selector)). The API pipeline manifest includes two base selectors for single/multiple record responses:

```yaml
selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data"] # data field wraps multiple record data responses
selector_single:
    type: RecordSelector
    extractor:
        type: DpathExtractor
        field_path: []
```

#### requester_base

The Requester defines how to prepare HTTP requests for the source API ([Docs](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/requester)). It specifies the API `base_url` and `authenticator` schema. Airbyte supports common authentication methods: `ApiKeyAuthenticator`, `BearerAuthenticator`, `BasicHttpAuthenticator`, and `OAuth`. Detailed configuration instructions are available in this [link](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/authentication).

#### retriever_base

A SimpleRetriever object fetches records through synchronous API requests ([Docs](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/reference#/definitions/SimpleRetriever)). It orchestrates the requester, record selector, and paginator. The API pipeline manifest includes a base retriever for each defined selector:

```yaml
retriever_base:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
retriever_single_base:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector_single"
```

#### paginator

Defines the pagination strategy for API endpoints returning multiple records ([Docs](https://docs.airbyte.com/connector-development/config-based/understanding-the-yaml-file/pagination)). Airbyte supports `Page increment`, `Offset increment`, and `Cursor based` pagination strategies. The `"#/definitions/NoPagination"` is automatically set for endpoints returning a single record.

### Endpoints Definitions

The `endpoints` section filters API endpoints from the paths defined in the OpenAPI spec file. Each endpoint should follow this schema:

- Endpoint path: Used as key. Can be enclosed in double quotes to inject parameters defined in `api_parameters` (e.g., `"/example/{foo}"`)
- id: String identifier for the endpoint
- primary_key (Optional): Field usable as primary key for each record
- responseSchema: Response schema returned by the API endpoint after applying the selector. Must match the OpenAPI schema definition
- textSchema: Fields to be parsed as texts during data chunking. Fields must be defined in `responseSchema`

Example:
```yaml
"/example/{foo}":
    id: "example"
    primary_key: "id"
    responseSchema: "#/schemas/exampleSchema"
    textSchema:
      $ref: "#/textSchemas/Example"
/about:
    id: "about"
    primary_key: "id"
    responseSchema: "#/schemas/aboutSchema"
    textSchema:
      $ref: "#/textSchemas/About"
```

### schemas

Endpoint response schemas should be listed here and referenced in the endpoint's `responseSchema`. Unwrapped schemas must match response schemas defined in the OpenAPI spec.

Example:

Endpoint response: `{data: [{id: "0", name: "foo", value: 2}, {id: "1", nane: "bar", b: 4}]}`

Endpoint schema:
```yaml
schemas:
    endpointSchema:
        type: object
            $schema: http://json-schema.org/draft-07/schema#
            properties:
                id:
                    type: string
                name:
                    type: string
                b:
                    type: integer
```

### textSchemas

For each endpoint, specify fields to be parsed as texts during data chunking. Fields must be included in the endpoint's `responseSchema`.

Example:

Endpoint response: `{data: [{id: "0", name: "foo", value: 2}, {id: "1", nane: "bar", b: 4}]}`

Endpoint textSchema:
```yaml
textSchemas:
    endpointTextSchema:
        type: object
        properties:
        name:
            type: string
```