version: "3.0.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []
  requester:
    type: HttpRequester
    url_base: "https://api.boardroom.info/v1"
    http_method: "GET"
    # request_options_provider:
    #   request_parameters:
    #     key: "{{ config['api_key'] }}"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: "{{ config['api_key'] }}"
      inject_into:
        type: RequestOption
        field_name: "key"
        inject_into: request_parameter
      
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: CursorPagination
        # page_size: "{{ config['page_size'] }}"
        cursor_value: "{{ response.get('nextCursor', '') }}"
        stop_condition: "{{ 'nextCursor' not in response }}"
      # page_size_option:
      #   type: RequestOption
      #   field_name: "limit"
      #   inject_into: "request_parameter"
      page_token_option:
        type: RequestOption
        field_name: "cursor"
        inject_into: "request_parameter"
    requester:
      $ref: "#/definitions/requester"
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  proposals_stream:
    $ref: "#/definitions/base_stream"
    schema_loader:
      type: InlineSchemaLoader
      schema:
       $ref: "#/schemas/Proposals"
    $parameters:
      name: "proposals"
      primary_key: "nextCursor" # TODO: ?
      path: "/protocols/{{ config['cname'] }}/proposals" # TODO: cname
  discourse_posts_stream:
    $ref: "#/definitions/base_stream"
    request_options_provider:
      request_parameters:
        protocol: "{{ config['cname'] }}"
    schema_loader:
      type: InlineSchemaLoader
      schema:
       $ref: "#/schemas/boardroom_api"
    $parameters:
      name: "discourse-posts"
      primary_key: "nextCursor" # TODO: ?
      path: "/discourseTopicPosts"
  # TODO: @santiago verify
  voters_stream:
    $ref: "#/definitions/base_stream"
    request_options_provider:
      request_parameters:
        protocol: "{{ config['cname'] }}"
    schema_loader:
      type: InlineSchemaLoader
      schema:
       $ref: "#/schemas/boardroom_api"
    $parameters:
      name: "voters"
      primary_key: "nextCursor" 
      path: "/protocols/{{ config['cname'] }}/voters?limit=100" 
  
  delegates_stream:
    $ref: "#/definitions/base_stream"
    request_options_provider:
      request_parameters:
        protocol: "{{ config['cname'] }}"
    schema_loader:
      type: InlineSchemaLoader
      schema:
       $ref: "#/schemas/boardroom_api"
    $parameters:
      name: "delegates"
      primary_key: "nextCursor" 
      path: "/delegates/getDelegatorsByProtocol/{{ config['cname'] }}" 
streams:
  - "#/definitions/proposals_stream"
  - "#/definitions/discourse_posts_stream"
  - "#/definitions/voters_stream"
  - "#/definitions/delegates_stream"

check:
  type: CheckStream
  stream_names:
    - "proposals"
    - "discourse-posts"
    - "voters"
    - "delegates"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/boardroom
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Boardroom API Spec
    type: object
    required:
      - api_key
      - cname
      - page_size
    additionalProperties: true
    properties:
      # 'TODO: This schema defines the configuration required for the source. This usually involves metadata such as database and/or authentication information.':
      api_key:
        type: string
        description: >-
          Boardroom API Key. See <a href="https://docs.boardroom.io/docs/api/05c1fb6d88a07-governance-api">here</a>
          for details.
        airbyte-secret: true
      cname:
        type: string
        description: >-
          Protocol ID a.k.a cname
        examples:
          - aave
          - hopprotocol
      page_size:
        type: integer
        description: pagination limit size

schemas:
  boardroom_api:
    type: object
    $schema: http://json-schema.org/draft-07/schema#
    properties:
      data:
        type: array
      nextCursor:
        type:
          - string
          - "null"

  Proposals:
    type: object
    $schema: http://json-schema.org/draft-07/schema#
    properties:
      data:
        type: array
        items:
          type: object
          properties:
            refId:
              type: string
            id:
              type: string
            title:
              type: string
            content:
              type: string
            protocol:
              type: string
            adapter:
              type: string
            proposer:
              type: string
            totalVotes:
              type: integer
            blockNumber:
              type: integer
            externalUrl:
              type: string
            startTime:
              type: object
              properties:
                timestamp:
                  type: integer
            endTime:
              type: object
              properties:
                timestamp:
                  type: integer
            startTimestamp:
              type: string
            endTimestamp:
              type: string
            currentState:
              type: string
            choices:
              type: array
              items:
                type: string
            results:
              type: array
              items:
                type: object
                properties:
                  total:
                    type: number
                  choice:
                    type: integer
            events:
              type: array
              items:
                type: object
                properties: {}
            type:
              type: string
            indexedResult:
              type: array
              items:
                type: object
                properties:
                  total:
                    type: string
                  choice:
                    type: string
            summary:
              type: string
            privacy:
              type: string
            indexedAt:
              type: integer
            txHash:
              type: string
            quorum:
              type: integer
      nextCursor:
        type:
          - string
          - "null"
